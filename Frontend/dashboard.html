<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard ‚Äî Event_Hub</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;color:#0b2133}
    :root{
      --bg:#e9f0fb; --sidebar:#f6f9ff; --accent:#2b66d5; --card:#ffffff; --muted:#6b7a89; --border:#e1e8f5;
    }
    body{background:var(--bg);display:flex}
    /* Sidebar */
    .sidebar{width:230px;background:var(--sidebar);min-height:100vh;border-right:1px solid var(--border);padding:22px 18px;position:fixed;left:0;top:0;overflow:auto}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:22px}
    .brand .logo{width:34px;height:34px;border-radius:6px;background:linear-gradient(135deg,var(--accent),#7c9df0);display:grid;place-items:center;color:white;font-weight:700}
    .brand h4{font-size:15px;color:#0b2133}
    .nav{margin-top:8px}
    .nav a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;text-decoration:none;color:var(--accent);font-weight:600;background:transparent;margin-bottom:8px;cursor:pointer}
    .nav a.active{box-shadow:inset 0 0 0 3px rgba(43,102,213,0.06);background:linear-gradient(90deg,rgba(43,102,213,0.06),rgba(43,102,213,0.03));border-left:3px solid var(--accent);padding-left:14px}
    .nav a:hover{transform:translateX(4px);transition:all 160ms}
    .create{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;text-decoration:none;color:#21364a;font-weight:600;margin-top:8px}
    /* Main */
    .main{margin-left:230px;padding:34px;flex:1}
    .header{display:flex;align-items:center;justify-content:space-between;gap:20px;opacity:0;transform:translateY(-10px)}
    .title{font-size:28px;font-weight:700;color:#0b2133}
    .subtitle{color:var(--muted);margin-top:6px}
    .card{margin-top:22px;background:var(--card);border-radius:10px;padding:22px;border:1px solid var(--border);box-shadow:0 6px 20px rgba(14,30,60,0.04);opacity:0;transform:scale(0.98)}
    .card h3{font-size:20px;margin-bottom:6px}
    .card p{color:var(--muted);font-size:13px;margin-bottom:16px}
    table{width:100%;border-collapse:collapse}
    thead th{padding:14px 12px;text-align:left;color:#2470d9;font-weight:700;border-bottom:1px solid var(--border)}
    tbody td{padding:12px;border-bottom:1px solid var(--border);color:#244054}
    .actions{display:flex;gap:12px;align-items:center}
    .btn{padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:#f6f9ff;color:var(--accent);font-weight:600;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
    .btn.secondary{background:transparent;color:#3d5061;border:1px solid var(--border)}
    .count{color:#334e6c;font-weight:600}
    /* modal */
    #createModal{display:none;position:fixed;inset:0;background:rgba(4,10,22,0.45);backdrop-filter:blur(4px);z-index:100;align-items:center;justify-content:center;}
    #createInner{width:520px;background:#fff;padding:22px;border-radius:10px;box-shadow:0 18px 50px rgba(3,10,30,0.3);transform:translateY(-10px);opacity:0;}
    #createInner.show{transform:translateY(0);opacity:1;transition:all 320ms cubic-bezier(.2,.8,.2,1)}
    input, textarea{font-family:inherit;color:#15202b}
    /* small helpers for animations */
    tbody tr{transition:all 0.36s ease}
    .sidebar, .header, .card{transition:all 0.36s ease}
    @media (max-width:900px){.sidebar{display:none}.main{margin-left:0;padding:18px}}
  </style>
</head>
<body>

  <aside class="sidebar">
    <div class="brand">
      <div class="logo">EH</div>
      <div><h4><b>Event_Hub</b></h4></div>
    </div>

    <nav class="nav" aria-label="Main navigation">
      <a id="navDashboard" class="active"><span class="icon">üè†</span> Dashboard</a>
      <a id="navCreate"><span class="icon">‚ûï</span> Create Event</a>
    </nav>

    <div style="margin-top:18px;color:var(--muted);font-size:13px">Version 1.0</div>
  </aside>

  <main class="main">
    <div class="header">
      <div>
        <div class="title">Admin Dashboard</div>
        <div class="subtitle">Manage your events and track attendees.</div>
      </div>
      <div style="min-width:220px;display:flex;align-items:center;justify-content:flex-end">
        <div style="background:#fff;border-radius:8px;padding:10px 14px;border:1px solid var(--border);min-width:160px;text-align:right;color:var(--muted);font-size:14px">admin@you.com</div>
      </div>
    </div>

    <div class="card">
      <h3 id="cardHeading">All Events</h3>
      <p id="cardSub">A list of all created events.</p>

      <div style="overflow:auto;margin-top:6px">
        <table aria-label="Events table">
          <thead>
            <tr>
              <th style="width:45%">Event Title</th>
              <th style="width:18%">Date</th>
              <th style="width:20%">Location</th>
              <th style="width:8%">Attendees</th>
              <th style="width:12%">Actions</th>
            </tr>
          </thead>
          <tbody id="eventsTbody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Create Modal -->
  <div id="createModal" aria-hidden="true">
    <div id="createInner">
      <h3 style="margin:0 0 8px 0;color:#0b2133">Create New Event</h3>
      <p style="margin:0 0 16px 0;color:#6b7a89">Fill out the form below to add a new event to the platform.</p>
      <div style="display:flex;flex-direction:column;gap:10px">
        <input id="evTitle" name="evTitle" placeholder="Event title e.g., Next.js Conf" style="padding:12px;border-radius:8px;border:1px solid var(--border);">
        <textarea id="evDesc" name="evDesc" placeholder="A brief summary of the event" rows="3" style="padding:12px;border-radius:8px;border:1px solid var(--border);"></textarea>
        <div style="display:flex;gap:10px">
          <input id="evDate" name="evDate" type="date" style="flex:1;padding:10px;border-radius:8px;border:1px solid var(--border);">
          <input id="evLocation" name="evLocation" placeholder="Location e.g., Virtual" style="flex:1;padding:12px;border-radius:8px;border:1px solid var(--border);">
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <input id="evAtt" name="evAtt" type="number" min="0" placeholder="Attendees" style="width:140px;padding:12px;border-radius:8px;border:1px solid var(--border);">
          <div style="flex:1"></div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:6px">
          <button id="cancelCreate" class="btn secondary">Cancel</button>
          <button id="submitCreate" class="btn">Create Event</button>
        </div>
      </div>
    </div>
  </div>
  <!-- EDIT EVENT MODAL -->
<div id="editModal" style="
    display:none; position:fixed; inset:0; 
    background:rgba(0,0,0,0.45); backdrop-filter:blur(4px);
    z-index:200; align-items:center; justify-content:center;
">
  <div id="editInner" style="
      width:520px; background:white; padding:22px; 
      border-radius:10px; box-shadow:0 18px 50px rgba(0,0,0,0.3);
  ">
    <h3>Edit Event</h3>
    <input id="editId" type="hidden">

    <input id="editTitle" placeholder="Event Title" style="margin-top:12px;padding:12px;width:100%;">
    <textarea id="editDesc" placeholder="Description" rows="3" style="margin-top:10px;padding:12px;width:100%;"></textarea>

    <div style="display:flex;gap:10px;margin-top:10px">
      <input id="editDate" type="date" style="flex:1;padding:10px;">
      <input id="editLocation" placeholder="Location" style="flex:1;padding:12px;">
    </div>

    <input id="editAtt" type="number" min="0" placeholder="Attendees" style="margin-top:10px;padding:12px;width:150px;">

    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:16px;">
      <button onclick="closeEditModal()" class="btn secondary">Cancel</button>
      <button onclick="saveEdit()" class="btn">Save</button>
    </div>
  </div>
</div>

  <!-- Attendees Popup Modal -->
<div id="attPopup" style="
    display:none; position:fixed; inset:0;
    background:rgba(0,0,0,0.55);
    backdrop-filter:blur(6px);
    z-index:500;
    align-items:center;
    justify-content:center;
">
  <div id="attBox" style="
      width:900px; max-width:95%;
      background:#ffffff;
      border-radius:12px;
      padding:28px;
      border:1px solid #dde6f5;
      box-shadow:0 25px 80px rgba(0,0,0,0.35);
      transform:scale(0.85);
      opacity:0;
  ">
    
    <div style="display:flex;justify-content:space-between;align-items:start;">
      <div>
        <h2 id="attEventTitle" style="margin-bottom:6px; font-weight:800;"></h2>
        <p style="color:#678; font-size:14px;">
          Track participation and get AI-powered recommendations for engagement.
        </p>
      </div>

      <button onclick="closeAttendees()" style="
          background:none;border:0;
          font-size:26px;cursor:pointer;color:#445;">
        ‚úï
      </button>
    </div>

    <div style="
        background:#f7faff;
        border:1px solid #d4e1f7;
        margin-top:18px;
        padding:20px;
        border-radius:10px;
    ">

      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h3 style="margin:0;">Attendee List</h3>
          <p id="attCount" style="margin:4px 0 12px; color:#678; font-size:13px;"></p>
        </div>

        <button id="recBtn" onclick="showRecommendations()" style="
            background:#2563eb; color:white;
            padding:10px 18px;
            border:none; border-radius:8px;
            font-weight:600;
            cursor:pointer;
        ">‚≠ê Get Recommendations</button>
      </div>

      <table style="width:100%; border-collapse:collapse; margin-top:12px;">
        <thead>
          <tr style="text-align:left; color:#678;">
            <th style="padding:8px;">Name</th>
            <th style="padding:8px;">Email</th>
            <th style="padding:8px;">Company</th>
            <th style="padding:8px;">Engagement</th>
          </tr>
        </thead>
        <tbody id="attTableBody"></tbody>
      </table>

      <div id="recBox" style="display:none; margin-top:16px; padding:16px; background:#fff; border-radius:10px; border:1px solid #dce4f5;">
      </div>

    </div>

  </div>
</div>


<script>
/* ----------------------
   REPLACED: removed static sample events
   Now events are loaded from backend via get_events.php
   ---------------------- */

let events = [];                // will be filled by loadEvents()
const tbody = document.getElementById('eventsTbody');

/* Render rows (keeps your animation behaviour) */
function renderRows(){
  tbody.innerHTML = '';
  events.forEach((ev, idx) => {
    const tr = document.createElement('tr');

    // try to format date nicely for display (if ISO yyyy-mm-dd)
    let displayDate = ev.event_date || ev.date || '';
    try {
      if (displayDate && displayDate.indexOf('-') !== -1) {
        const d = new Date(displayDate + 'T00:00:00');
        displayDate = d.toLocaleDateString();
      }
    } catch(e){ /* keep raw if parse fails */ }

    tr.innerHTML = `
      <td>${escapeHtml(ev.title)}</td>
      <td>${escapeHtml(displayDate)}</td>
      <td>${escapeHtml(ev.location || '')}</td>
      <td><span class="count">${escapeHtml(String(ev.attendees || 0))}</span></td>
      <td>
  <div class="actions">
    <button class="btn" onclick="openAttendees('${ev.title}', ${ev.id})">üë• View</button>
    <button class="btn secondary" onclick="openEdit(${ev.id}, '${ev.title}', '${ev.description}', '${ev.event_date}', '${ev.location}', ${ev.attendees})">‚úèÔ∏è Edit</button>
    <button class="btn" style="background:#ffdddd;color:#c0392b" onclick="deleteEventById(${ev.id})">üóë Delete</button>
  </div>
</td>
    `;
    tbody.appendChild(tr);

    // entrance animation
    tr.style.opacity = 0; tr.style.transform = 'translateY(8px)';
    setTimeout(()=>{ tr.style.transition = 'all 420ms ease'; tr.style.opacity = 1; tr.style.transform = 'translateY(0)'; }, 80 + idx*70);
  });
}

/* Escape helpers to avoid injection when inserting into DOM */
function escapeHtml(s){
  if(!s) return '';
  return String(s).replace(/[&<>"']/g, function(m){ return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]; });
}
function escapeJs(s){
  if(!s) return '';
  return String(s).replace(/'/g,"\\'").replace(/"/g,'\\"');
}

/* ----------------------
   Load events from backend
   ---------------------- */
function loadEvents(){
  fetch("../Backend/get_events.php")
    .then(r => r.json())
    .then(data => {
      if(Array.isArray(data)) {
        events = data;
      } else {
        events = [];
      }
      renderRows();
    })
    .catch(err => {
      console.error('Failed to load events', err);
      events = [];
      renderRows();
    });
}
loadEvents();

/* Row action delegation (keeps your original edit behavior) */
tbody.addEventListener('click', (ev) => {
  const btn = ev.target.closest('button');
  if(!btn) return;
  const idx = Number(btn.dataset.idx);
  const action = btn.dataset.action;
  if(action === 'view') viewAttendees(idx);
  if(action === 'edit') editEvent(idx);
});

/* Your original view/edit functions remain ‚Äî they now work on backend-loaded events */
function viewAttendees(i){
  const ev = events[i];
  const list = prompt(`Attendees for "${ev.title}" (comma separated):`, '');
  if(list !== null) alert('Attendees: ' + list);
}
function editEvent(i){
  const ev = events[i];
  const newTitle = prompt('Edit event title', ev.title);
  if(newTitle){
    // local edit only ‚Äî if you want server-side edit, we can add it later
    ev.title = newTitle;
    renderRows();
  }
}

/* UI entrance animations for header/card/sidebar (unchanged) */
window.addEventListener('DOMContentLoaded', ()=>{
  const sidebar = document.querySelector('.sidebar');
  const header = document.querySelector('.header');
  const card = document.querySelector('.card');
  setTimeout(()=>{ sidebar.style.opacity = 1; sidebar.style.transform = 'translateX(0)'; }, 80);
  setTimeout(()=>{ header.style.opacity = 1; header.style.transform = 'translateY(0)'; }, 200);
  setTimeout(()=>{ card.style.opacity = 1; card.style.transform = 'scale(1)'; }, 360);
});

/* Navigation (unchanged) */
const navDashboard = document.getElementById('navDashboard');
const navCreate    = document.getElementById('navCreate');
const cardHeading  = document.getElementById('cardHeading');
const cardSub      = document.getElementById('cardSub');

function setActiveNav(el){
  document.querySelectorAll('.nav a').forEach(a=>a.classList.remove('active'));
  el.classList.add('active');
}

navDashboard.addEventListener('click', (e)=>{
  e.preventDefault();
  setActiveNav(navDashboard);
  cardHeading.textContent = 'All Events';
  cardSub.textContent = 'A list of all created events.';
  loadEvents();
});

navCreate.addEventListener('click', (e)=>{
  e.preventDefault();
  setActiveNav(navCreate);
  openCreateModal();
});

/* Modal logic (unchanged) */
const createModal = document.getElementById('createModal');
const createInner = document.getElementById('createInner');
const cancelCreate = document.getElementById('cancelCreate');
const submitCreate = document.getElementById('submitCreate');

function openCreateModal(){
  createModal.style.display = 'flex';
  setTimeout(()=> createInner.classList.add('show'), 20);
}
function closeCreateModal(){
  createInner.classList.remove('show');
  setTimeout(()=> createModal.style.display = 'none', 260);
}
cancelCreate.addEventListener('click', (e)=> { e.preventDefault(); closeCreateModal(); });

/* ----------------------
   CREATE-SUBMISSION -> send to backend add_event.php
   ---------------------- */
submitCreate.addEventListener('click', (e)=>{
  e.preventDefault();
  const title = document.getElementById('evTitle').value.trim();
  const desc = document.getElementById('evDesc').value.trim();
  const dateVal = document.getElementById('evDate').value;
  const location = document.getElementById('evLocation').value.trim() || 'TBD';
  const attendees = parseInt(document.getElementById('evAtt').value || '0', 10);

  if(!title || !dateVal){
    const el = !title ? document.getElementById('evTitle') : document.getElementById('evDate');
    el.animate([{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:260});
    el.focus();
    return;
  }

  // POST to backend
  const fd = new FormData();
  fd.append("title", title);
  fd.append("description", desc);
  fd.append("event_date", dateVal);
  fd.append("location", location);
  fd.append("attendees", attendees);

  fetch("../Backend/add_event.php", {
    method: "POST",
    body: fd
  })
  .then(r => r.json())
  .then(data => {
    if(data && data.status === "success"){
      // success animation + refresh
      document.querySelector('.card').animate([{transform:'scale(.995)'},{transform:'scale(1)'}], {duration:260});
      closeCreateModal();
      // reload events list from server
      loadEvents();
    } else {
      alert("Failed to create event. Server returned error.");
    }
  })
  .catch(err => {
    console.error(err);
    alert("Server error while creating event.");
  });
});

/* close modal on ESC or click outside */
createModal.addEventListener('click', (e)=>{
  if(e.target === createModal) closeCreateModal();
});
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeCreateModal(); });

/* SAMPLE ATTENDEES DATA (kept for popup demo) */
const attendeesData = {
  "Next.js Global Summit": [
    {name:"Alice Johnson", email:"alice@example.com", company:"TechCorp", minutes:240, questions:5, rating:5},
    {name:"Bob Williams", email:"bob@example.com", company:"Innovate LLC", minutes:210, questions:1, rating:4},
    {name:"Charlie Brown", email:"charlie@example.com", company:"Solutions Inc.", minutes:180, questions:0, rating:3}
  ]
};

// üéâ OPEN ATTENDEES POPUP (keeps using attendeesData)
function openAttendees(eventName){
  const popup = document.getElementById("attPopup");
  const box = document.getElementById("attBox");

  // Insert event title
  document.getElementById("attEventTitle").textContent =
    "Attendees for " + eventName;

  // Insert attendee count
  const list = attendeesData[eventName] || [];
  document.getElementById("attCount").textContent =
    `${list.length} people have registered for this event.`;

  // Fill table
  const tbody = document.getElementById("attTableBody");
  tbody.innerHTML = "";

  list.forEach(a => {
    tbody.innerHTML += `
      <tr>
        <td style="padding:8px; font-weight:600;">${a.name}</td>
        <td style="padding:8px;">${a.email}</td>
        <td style="padding:8px;">${a.company}</td>
        <td style="padding:8px;">${a.minutes}min ‚Ä¢ ${a.questions} Qs ‚Ä¢ ${a.rating} ‚≠ê</td>
      </tr>
    `;
  });

  // Show popup
  popup.style.display = "flex";

  // Animation
  setTimeout(() => {
    box.style.opacity = "1";
    box.style.transform = "scale(1)";
    box.style.transition = "all 0.35s ease";
  }, 10);
}

function closeAttendees(){
  const popup = document.getElementById("attPopup");
  const box = document.getElementById("attBox");

  box.style.opacity = "0";
  box.style.transform = "scale(0.85)";

  setTimeout(() => popup.style.display = "none", 250);
}

function showRecommendations(){
  const rec = document.getElementById("recBox");
  rec.style.display = "block";
  rec.innerHTML = `
    <h4 style="margin-bottom:8px;">Recommended Actions</h4>
    <ul style="color:#345; line-height:1.6;">
      <li>Send personalized follow-up to high-engagement users.</li>
      <li>Encourage low-engagement attendees with networking invites.</li>
      <li>Share event recording with attendees who asked fewer questions.</li>
    </ul>
  `;
}

/* The following localStorage helpers are left in place but are now unused by create flow.
   They can be removed if you prefer server-only storage. */
const EVENTS_KEY = 'eh_events';
function loadStoredEvents(){
  try{
    const raw = localStorage.getItem(EVENTS_KEY);
    return raw ? JSON.parse(raw) : [];
  }catch(e){
    console.error('Failed to read events', e);
    return [];
  }
}
function saveStoredEvents(arr){
  localStorage.setItem(EVENTS_KEY, JSON.stringify(arr));
}

/* Legacy function (kept in case you used it elsewhere) now delegates to server */
function createEventFromForm(redirectToEvents = true){
  const title = (document.getElementById('evTitle') || {}).value || '';
  const desc  = (document.getElementById('evDesc') || {}).value || '';
  const date  = (document.getElementById('evDate') || {}).value || '';
  const location = (document.getElementById('evLocation') || {}).value || '';
  const attendees = parseInt((document.getElementById('evAtt') || {}).value || '0', 10) || 0;

  if(!title || !date){
    alert('Please fill required fields: title and date');
    return false;
  }

  // use the same backend add flow as the modal submit
  const fd = new FormData();
  fd.append("title", title);
  fd.append("description", desc);
  fd.append("event_date", date);
  fd.append("location", location);
  fd.append("attendees", attendees);

  fetch("../Backend/add_event.php", { method: "POST", body: fd })
    .then(r => r.json())
    .then(data => {
      if (data && data.status === 'success') {
        if (redirectToEvents) {
          loadEvents();
          window.location.href = 'events.html'; // optional behavior kept from your original function
        }
      } else {
        alert("Failed to create event (legacy path).");
      }
    });

  return true;
}

/* Attach legacy submit button if present */
const submitBtn = document.getElementById('submitCreate');
if(submitBtn){
  // already attached above ‚Äî this is safe to keep
}

/* fallback: if you want to auto-refresh every 30s uncomment below */
// setInterval(loadEvents, 30000);

/* ---------------------------
   OPEN EDIT MODAL
---------------------------- */
function openEdit(id, title, desc, date, location, attendees){

  document.getElementById('editId').value = id;
  document.getElementById('editTitle').value = title;
  document.getElementById('editDesc').value = desc;
  document.getElementById('editDate').value = date;
  document.getElementById('editLocation').value = location;
  document.getElementById('editAtt').value = attendees;

  document.getElementById("editModal").style.display = "flex";
}

/* ---------------------------
   CLOSE EDIT MODAL
---------------------------- */
function closeEditModal(){
  document.getElementById("editModal").style.display = "none";
}

/* ---------------------------
   SAVE EDIT (update_event.php)
---------------------------- */
function saveEdit(){

  const id = document.getElementById('editId').value;
  const title = document.getElementById('editTitle').value.trim();
  const desc = document.getElementById('editDesc').value.trim();
  const date = document.getElementById('editDate').value;
  const location = document.getElementById('editLocation').value.trim();
  const attendees = document.getElementById('editAtt').value;

  if(!title || !date){
    alert("Title and Date are required");
    return;
  }

  const fd = new FormData();
  fd.append("id", id);
  fd.append("title", title);
  fd.append("description", desc);
  fd.append("event_date", date);
  fd.append("location", location);
  fd.append("attendees", attendees);

  fetch("../Backend/update_event.php", {
    method: "POST",
    body: fd
  })
  .then(r => r.json())
  .then(data => {
    if(data.status === "success"){
      closeEditModal();
      loadEvents();
    } else {
      alert("Update failed.");
    }
  })
  .catch(err => {
    console.error(err);
    alert("Server error while updating event.");
  });
}

/* ----------------------
   DELETE EVENT
----------------------- */
function deleteEventById(id){
  if(!confirm("Are you sure you want to delete this event?")) return;

  const fd = new FormData();
  fd.append("id", id);

  fetch("../Backend/delete_event.php", {
    method: "POST",
    body: fd
  })
  .then(res => res.json())
  .then(data => {
    if(data.status === "success"){
      loadEvents();   // refresh table
    } else {
      alert("Failed to delete event.");
    }
  })
  .catch(err => {
    console.error(err);
    alert("Server error while deleting.");
  });
}


</script>
</body>
</html>
